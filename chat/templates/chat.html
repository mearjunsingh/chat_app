<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
</head>

<body>
    <p>
        <a href="{% url 'home_page_view' %}">Back</a> | {{ room_name }}
    </p>

    <div id="message_box">
        {% for message in messages %}
        <div>
            <small>{{ message.user }}:</small> {{ message.message }}
        </div>
        {% endfor %}
    </div>

    <input type="text" id="message_input" onkeypress="sendByEnter(event)" placeholder="Type your message" autofocus>
    <button type="button" id="send_btn" onclick="sendMessage()">Send</button>


    <script>
        function scrollToBottom() {
            var objDiv = document.getElementById("message_input");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        scrollToBottom();

        const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/{{ room_name }}/{{ user }}/");

        socket.onopen = function (e) {
            console.log("Connection established!");
        };

        socket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            var message_box = document.getElementById("message_box");
            var message = document.createElement("div");

            message.innerHTML = `<small>${data.user}:</small> ${data.message}`;
            message_box.append(message);
            scrollToBottom();
        };

        sendMessage = function () {
            var message = document.getElementById("message_input").value;
            var data = { "message": message };

            if (message.length > 0) {
                socket.send(JSON.stringify(data));
            }

            document.getElementById("message_input").value = "";
        }

        sendByEnter = function (e) {
            if (e.code == 'Enter') {
                sendMessage();
            }
        }
    </script>

</body>

</html>